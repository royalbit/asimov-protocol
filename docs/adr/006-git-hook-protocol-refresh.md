# ADR-006: Git Hook Protocol Refresh

**Status:** Accepted
**Date:** 2025-11-27
**Authors:** Claude (Opus 4.5) - Principal Autonomous AI

## Context

The Self-Healing Protocol (ADR-002, ADR-003) relies on CLAUDE.md being auto-loaded by Claude Code to trigger warmup.yaml re-reads after context compaction. However, there's a critical failure mode:

**Problem:** After aggressive context compaction, even CLAUDE.md instructions may be summarized or lost. The bootstrap chain breaks:

```
CLAUDE.md â†’ "re-read warmup.yaml" â†’ full rules restored
    â†‘
    â””â”€â”€ If this gets compacted/lost, recovery fails
```

**Observation:** Context compaction happens every **~10-20 minutes** with heavy reasoning (ADR-003). Git commits happen frequently during ASIMOV MODE sessions (5-20 commits per session, roughly every ~15 minutes). Each commit triggers pre-commit hooks, which produce **fresh terminal output** that enters the AI's context window.

**Key Insight:** Hook output is *external* to the AI's memory - it comes from the filesystem execution, not from compacted context. It cannot be compacted because it hasn't happened yet when compaction occurs.

## Decision

Implement a `asimov-mode refresh` command that outputs protocol reminders, and call it from git pre-commit hooks.

### The Refresh Command

```bash
$ asimov-mode refresh

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¤– ASIMOV MODE - PROTOCOL REFRESH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ON CONFUSION â†’ re-read warmup.yaml

RULES: 4hr max | 1 milestone | tests pass | ship it

QUALITY GATES:
  tests: cargo test
  lint: cargo clippy -- -D warnings

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Hook Integration

The pre-commit hook calls the Rust CLI instead of using bash scripts:

```bash
#!/bin/bash
# .hooks/pre-commit (generated by asimov-mode init --asimov)

# Protocol refresh - injects rules into fresh context
asimov-mode refresh

# Quality gates
cargo fmt --check || exit 1
cargo clippy -- -D warnings || exit 1
cargo test || exit 1
```

### Why Rust CLI, Not Bash

| Bash Script | Rust CLI |
|-------------|----------|
| Logic scattered in shell | Single source of truth |
| grep/sed for YAML parsing | Proper serde_yaml parsing |
| No validation | Validates warmup.yaml exists |
| Hard to update | Update CLI, all hooks benefit |
| Platform-specific issues | Cross-platform Rust |

## Consequences

### Positive

1. **Compaction-Resistant:** Hook output is fresh input, not compacted memory
2. **Frequency = Reliability:** More commits = more protocol refreshes
3. **External Trigger:** Filesystem-based, not memory-based
4. **Consistent:** Same Rust CLI handles all protocol operations
5. **Validates:** Can check warmup.yaml exists and is valid before outputting rules

### Negative

1. **Requires CLI Installation:** `asimov-mode` must be in PATH
2. **Hook Setup:** Users must install hooks (mitigated by `--asimov` setup)

### Requirements

**Commit Cadence Rule:** For self-healing to work, commits must happen at least as often as compaction (~15 minutes).

| Compaction | Commit Cadence | Self-Healing |
|------------|----------------|--------------|
| Every ~15 min | Every ~15 min | âœ“ Works |
| Every ~15 min | Every ~30 min | âš  Gaps |
| Every ~15 min | Every ~2 hours | âœ— Broken |

**Enforcement:** Add to sprint autonomy rules:
- "Commit at least every 15 minutes during active development"
- "Commit after every task completion, even if small"
- "Small commits > large commits (for self-healing)"

### Neutral

1. **Additional Output:** Adds ~10 lines to each commit's terminal output
2. **Slight Delay:** Adds <100ms to commit time (negligible)

## Implementation

### CLI Command

```rust
// cli/src/main.rs - new Refresh command

/// Refresh protocol context (for git hooks)
Refresh {
    /// Show verbose output including quality gates from warmup.yaml
    #[arg(short, long)]
    verbose: bool,
}
```

### Refresh Logic

```rust
fn cmd_refresh(verbose: bool) -> ExitCode {
    println!();
    println!("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    println!("ğŸ¤– ASIMOV MODE - PROTOCOL REFRESH");
    println!("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    println!();
    println!("ON CONFUSION â†’ re-read warmup.yaml");
    println!();
    println!("RULES: 4hr max | 1 milestone | tests pass | ship it");

    if verbose {
        // Parse warmup.yaml and output quality gates
        if let Ok(content) = std::fs::read_to_string("warmup.yaml") {
            // Extract and display quality section
        }
    }

    println!();
    println!("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

    ExitCode::SUCCESS
}
```

### Hook Template Update

```rust
pub fn precommit_hook_template(project_type: ProjectType) -> String {
    format!(r#"#!/bin/bash
# Asimov Protocol pre-commit hook
# Generated by: asimov-mode init --asimov

# Protocol refresh - injects rules into fresh context
asimov-mode refresh

# Quality gates
{quality_checks}
"#, quality_checks = quality_checks_for(project_type))
}
```

## Interaction with Other ADRs

- **ADR-002/003 (Self-Healing):** This is an additional recovery mechanism, not a replacement
- **ADR-001 (Green Coding):** Local CLI execution, zero cloud tokens

## Recovery Strategy Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RECOVERY STRATEGY LAYERS                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Layer 1: CLAUDE.md (auto-loaded)                                  â”‚
â”‚           â””â”€â”€ May survive compaction                                â”‚
â”‚                                                                     â”‚
â”‚  Layer 2: Git Hook Refresh (this ADR)                              â”‚
â”‚           â””â”€â”€ Fresh output on every commit                          â”‚
â”‚           â””â”€â”€ Cannot be compacted (hasn't happened yet)             â”‚
â”‚                                                                     â”‚
â”‚  Layer 3: Manual "run warmup" trigger                              â”‚
â”‚           â””â”€â”€ User can always invoke                                â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Validation

The effectiveness can be measured by:

1. **Protocol adherence** after multiple compaction cycles (~15 min each)
2. **Quality gate compliance** across commits
3. **Session completion rate** (milestones shipped vs abandoned)

## References

- [ADR-002: Self-Healing Protocol](002-self-healing-protocol.md)
- [ADR-003: Self-Healing Based on Real Compaction Data](003-self-healing-real-compaction-data.md)
- [Asimov Protocol Specification](../SPECIFICATION.md)
