# ADR-032: Project Context File + Templates

**Status:** Implementing (v8.1.0)
**Date:** 2025-12-02
**Deciders:** Human + Claude (Principal Autonomous AI)
**Priority:** CRITICAL

## Context

### Problem 1: warmup.yaml Was Doing Two Jobs

Before v8.0.0, `warmup.yaml` served dual purposes:

| Purpose | Type | Example Content |
|---------|------|-----------------|
| **Session behavior** | Universal | "load protocols", "validate", "read roadmap" |
| **Project context** | Per-project | identity, build commands, file structure |

ADR-031 correctly hardcoded the **session behavior** into the binary. But it also deleted the **project context** - which is project-specific and cannot be hardcoded.

### Problem 2: Projects Lost Their Identity

After `asimov update` (v8.0.0), projects lost:

```yaml
# This was deleted but shouldn't have been
identity:
  project: "Mouvify API"
  type: rust
  stack: "Rust + Axum + MongoDB"

quality:
  test: "cargo test --release"
  lint: "cargo clippy --release -- -D warnings"

files:
  source:
    - "src/main.rs - Server entry point"
    - "src/api/ - Route handlers"
```

### Problem 3: No Project Type Detection

When initializing a new project, users had to manually specify `--type rust` even when `Cargo.toml` exists.

## Decision

### 1. Split warmup.yaml Into Two Concepts

| Concept | Location | Content |
|---------|----------|---------|
| **Warmup Protocol** | Hardcoded in binary | Session behavior (universal) |
| **Project Context** | `.asimov/project.yaml` | Project-specific data |

### 2. Project Templates (7 Types)

Templates stored in `cli/src/templates/` and compiled into binary:

```
cli/src/templates/
â”œâ”€â”€ project-rust.yaml.tpl
â”œâ”€â”€ project-python.yaml.tpl
â”œâ”€â”€ project-node.yaml.tpl
â”œâ”€â”€ project-go.yaml.tpl
â”œâ”€â”€ project-flutter.yaml.tpl
â”œâ”€â”€ project-docs.yaml.tpl
â””â”€â”€ project-generic.yaml.tpl
```

### 3. project.yaml Schema

```yaml
# .asimov/project.yaml - Project-specific context
# Generated by: asimov init --type rust

identity:
  name: "my-project"          # Required - filled by user or prompt
  type: rust                   # Required - from template
  version: "0.1.0"            # Optional
  tagline: "Brief description" # Optional

quality:
  test: "cargo test"
  lint: "cargo clippy -- -D warnings"
  format: "cargo fmt --check"

files:
  source: ["src/"]
  config: ["Cargo.toml"]
  docs: ["README.md"]

patterns:                      # Language-specific best practices
  - "Result<T, E> for errors, no panics"
  - "thiserror for custom errors"
  - "No unwrap() in library code"
```

### 4. Project Type Detection

Auto-detect project type from marker files:

| Marker File | Detected Type |
|-------------|---------------|
| `Cargo.toml` | rust |
| `pyproject.toml` or `setup.py` | python |
| `package.json` | node |
| `go.mod` | go |
| `pubspec.yaml` | flutter |
| `*.md` only | docs |
| (none) | generic |

### 5. Warmup Behavior Update

```
asimov warmup (or refresh)
    â”‚
    â–¼
Load hardcoded protocols (asimov, green, sycophancy, etc.)
    â”‚
    â–¼
Check .asimov/project.yaml
    â”‚
    â”œâ”€â–º EXISTS + complete
    â”‚       â”‚
    â”‚       â–¼
    â”‚   Load project context, continue
    â”‚
    â””â”€â–º MISSING or incomplete
            â”‚
            â–¼
        Detect project type (or ask user)
            â”‚
            â–¼
        Prompt: "Starting fresh project. What's this about?"
            â”‚
            â–¼
        Generate project.yaml from template + user input
            â”‚
            â–¼
        Continue with warmup
```

### 6. Migration Strategy (`asimov update`)

For existing projects with old warmup.yaml:

1. **Detect** existing `.asimov/warmup.yaml`
2. **Extract** project-specific fields:
   - identity (project, tagline, type, version)
   - quality (test, lint, format commands)
   - files (source, config, docs, tests)
   - patterns (language-specific)
3. **Generate** `.asimov/project.yaml` from extracted data
4. **Delete** deprecated files (warmup.yaml, checkpoint, etc.)
5. **Preserve** roadmap.yaml (project data)
6. **Install/update** hooks

### 7. File Structure (v8.1.0)

```
.asimov/
â”œâ”€â”€ roadmap.yaml      # WHAT to build (milestones) - preserved
â””â”€â”€ project.yaml      # HOW to build (project context) - NEW
```

### 8. ASIMOV MODE Feature

Trigger phrase detection for autonomous execution:

```
User: "asimov mode"
    â”‚
    â–¼
ğŸ¤– ASIMOV MODE - AUTONOMOUS EXECUTION ENGAGED
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Session: 4h MAX (per sprint rules)
Mode: Full autonomy until roadmap exhausted or stopped
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

Integrated into session-start hook for consistent UX.

## Implementation

### Files Created/Modified

**New Files:**
- `cli/src/templates/project-*.yaml.tpl` (7 templates)
- `cli/src/schemas/project.rs` (schema)
- `docs/adr/032-project-context-file.md` (this ADR)

**Modified Files:**
- `cli/src/templates.rs` - Add `project_template(type)` generator
- `cli/src/protocols/warmup.tpl` - Add `load_project` step
- `cli/src/main.rs` - Update init, update, warmup commands
- `cli/src/validator.rs` - Add project.yaml validation
- `cli/src/lib.rs` - Add project type detection
- `docs/SPECIFICATION.md` - Update file structure

**Deleted Files:**
- `cli/src/schemas/checkpoint.rs` (deprecated)

### Removed: Checkpoint Mechanism

ADR-007's checkpoint mechanism is fully deprecated:
- Schema removed from `cli/src/schemas/`
- Template removed from `templates.rs`
- Validation removed from `validator.rs`
- Hooks now handle context recovery (ADR-031)

## Consequences

### Positive

- **Project context preserved**: Projects keep their identity after update
- **Auto-detection**: No need to specify `--type` when markers exist
- **Fresh project flow**: Guided initialization for new projects
- **Clean separation**: Behavior (hardcoded) vs data (project.yaml)
- **Migration path**: Existing projects can upgrade smoothly

### Negative

- **One more file**: `.asimov/project.yaml` added to structure
- **Template maintenance**: 7 templates to keep updated

### Neutral

- **Breaking change**: Old warmup.yaml format not directly compatible
- **Migration required**: Existing projects need `asimov update`

## References

- [ADR-031: Enforced Protocol Loading](031-enforced-protocol-loading.md) - Created the split
- [ADR-007: Checkpoint Size Limits](007-checkpoint-size-limits.md) - Deprecated by this ADR
- [ADR-002: Self-Healing Protocol](002-self-healing-protocol.md) - Original warmup.yaml design
