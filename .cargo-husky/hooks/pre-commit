#!/bin/bash
# Asimov Protocol pre-commit hook - mirrors CI checks
# Auto-installed by cargo-husky on `cargo test`

set -e

# Get the repo root directory
REPO_ROOT="$(git rev-parse --show-toplevel)"
CLI_DIR="$REPO_ROOT/cli"

echo "Running pre-commit checks..."

if [ -d "$CLI_DIR" ]; then
    cd "$CLI_DIR"

    echo "Checking formatting..."
    cargo fmt --all -- --check

    echo "Running clippy..."
    cargo clippy -- -D warnings
fi

cd "$REPO_ROOT"

# Use local build if available, otherwise installed version
if [ -f "$CLI_DIR/target/release/asimov-mode" ]; then
    FP="$CLI_DIR/target/release/asimov-mode"
elif [ -f "$CLI_DIR/target/debug/asimov-mode" ]; then
    FP="$CLI_DIR/target/debug/asimov-mode"
elif command -v asimov-mode &> /dev/null; then
    FP="asimov-mode"
else
    echo "Warning: asimov-mode not found, skipping protocol checks"
    echo "Pre-commit checks passed!"
    exit 0
fi

echo "Validating protocol files..."
$FP validate .

echo "Linting documentation..."
$FP lint-docs docs/

# Self-healing: inject protocol refresh into context (ADR-006)
# Compaction happens every ~15 min, commits are frequent - this is the refresh trigger
$FP refresh

echo "Pre-commit checks passed!"
